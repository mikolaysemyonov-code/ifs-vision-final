# Технический отчёт: IFS Vision / Digital Twin Studio

Документ для AI-партнёра: структура продукта, стек, киллер-фичи, дизайн-система, логика данных и зоны сложности.

---

## 1. Суть продукта

**IFS Vision** (бренд **Digital Twin Studio**) — это **интеллектуальный финтех-симулятор недвижимости** с white-label возможностями. Главная задача: дать пользователю на одной странице **наглядный финансовый сценарий** «покупка vs аренда» и **визуализацию владения** (Digital Twin квартиры) в привязке к его параметрам (цена, взнос, ставка, срок).

- **Для кого:** клиенты агентств/застройщиков, которые хотят за минуту увидеть выгоду покупки, график погашения долга и «вердикт» в рублях.
- **Ценность:** один интерфейс — слайдеры, график, цифровой двойник планировки, кнопка «Получить отчёт в PDF»; бренд и ставки настраиваются из админки без правки кода.

---

## 2. Архитектура и стек

### Фронтенд и сборка
- **Next.js 16** (App Router), **React 19**, **TypeScript**
- **Tailwind CSS v4** — утилитарные классы, кастомная тема в `globals.css`
- **Zustand** — глобальное состояние симулятора (цена, взнос, ставка, срок, сценарий, **конфиг из админки**)
- **Framer Motion** — анимации появления, переходы вкладок, режим презентации в админке
- **Recharts** — график погашения долга (AreaChart)
- **Lucide React** — иконки по всему проекту

### Состояние (state)
- **Симулятор (главная страница):** Zustand store (`useStore`). Ключевое: `config` (бренд, инфляция, базовые ставки) при инициализации и по событию `ifsVisionAdminUpdated` подтягивается из **localStorage** через `getConfigFromStorage()` / `getAdminSettings()`.
- **Админка:** локальный React state (`useState`) для `settings` (полный объект `AdminSettings`). Персистенция — **только localStorage** (ключ `ifsVisionAdmin`). Серверной БД для настроек нет.
- **Синхронизация:** главная страница при монтировании вызывает `loadConfigFromStorage()` и подписывается на `ifsVisionAdminUpdated`; после сохранения в админке диспатчится это событие, и симулятор перечитывает конфиг. Так бренд, ставки и инфляция на главной всегда соответствуют последним сохранённым настройкам.

### Маршрутизация
- **`/`** — главная страница симулятора (единственный публичный маршрут продукта).
- **`/studio-admin`** — панель управления (защищённая). Без cookie доступа нет.
- **`/studio-admin/login`** — страница входа (форма пароля, без cookie).
- **`/admin`** — редирект на `/studio-admin/login` для обратной совместимости ссылок.

### Защита админки (Auth)
- **Вход:** только через **API**. `POST /api/login` с телом `{ "password": "..." }`. Пароль сравнивается с **`process.env.ADMIN_PASSWORD`** на сервере. При успехе выставляется **HTTP-only cookie** `admin_session` (1 час, SameSite=Lax, в production — Secure).
- **Проверка доступа:** **Next.js middleware** (`src/middleware.ts`). Для путей `/studio-admin` и `/studio-admin/:path*` (кроме `/studio-admin/login`) проверяется наличие cookie `admin_session`; при отсутствии — **редирект 307 на `/`**. Клиентская проверка пароля полностью убрана; упоминания дефолтного пароля в клиенте удалены.
- **Выход:** `POST /api/logout` сбрасывает cookie; клиент затем делает `router.push('/')`.
- **Смена пароля в UI:** «текущий пароль» проверяется через `POST /api/verify-password`; новый пароль сохраняется только в `settings.adminPassword` в localStorage (для отображения). Фактический вход по-прежнему только по `ADMIN_PASSWORD` на сервере.

---

## 3. Киллер-фичи

- **Live ROI Preview (виджет в админке)**  
  Плавающий блок с предпросмотром ROI по трём стратегиям (Инвестиция, Семья, Старт). Обновляется в реальном времени при изменении ставок банка, роста цен и глобальной инфляции. Справа от каждого ROI — **Sparkline** (мини-график капитала за 20 лет). При отрицательной итоговой выгоде линия подсвечивается rose.

- **Sparklines в админке**  
  Функция `getEquityCurve(bankRate, priceGrowth, inflationRate)` считает 10 точек капитала за 20 лет: стоимость квартиры с ростом минус остаток долга (аннуитет). Рост задаётся как **инфляция + премия** (поле «Рост цен»). SVG 80×32 в виджете и 240×96 в режиме презентации, с заливкой под кривой (fill-opacity 0.1).

- **Режим презентации (Presentation Mode)**  
  Кнопка в шапке админки переключает в полноэкранный режим: скрываются все секции настроек, остаётся только развёрнутый Live ROI Preview (карточки стратегий крупно, Sparklines в 3 раза больше). Фон — глубокий чёрный с анимированным градиентом в стиле macOS. Выход — Esc или кнопка закрытия. Анимации перехода — Framer Motion, 0.5 s ease.

- **Apple-style админ-панель**  
  Сегментированный контроль (Настройки | Интеграции | Безопасность). Секции в стиле glass: `bg-white/5`, `border-white/10`, `rounded-2xl`/`rounded-3xl`, `backdrop-blur-xl`. Тумблеры, пресеты ставок, три карточки безопасности (пароль, автоблокировка, приватность и логи). Иконки Lucide (Shield, Key, Clock, Gauge, Lock и др.).

- **Экспорт отчёта в PDF (через Screenshot API)**  
  Кнопка «Получить детальный план в PDF» на главной отправляет текущий URL с query-параметрами `export=1`, `ts`, `showTs` в `POST /api/pdf`. Сервер дергает **Screenshotone API** (селектор `#simulation-report`), возвращает JPG. В момент экспорта на странице показывается футер с датой/времением формирования (МСК) и текстом «Официальный расчет {companyName}. Сформировано: …». Опция в админке «Отображать время в отчёте» управляет видимостью этой метки.

- **Динамическая дата/время в отчёте**  
  `getCurrentTimestamp()` и `formatTimestampFromEpoch()` через `Intl.DateTimeFormat` в формате «ДД.ММ.ГГГГ, ЧЧ:ММ (МСК)». В интерфейсе — индикатор «Данные актуальны на {время}» с зелёной пульсирующей точкой; время обновляется раз в минуту.

- **Автоблокировка админки**  
  Таймер неактивности (mousemove, keydown, click, scroll). Варианты: 5 / 15 / 30 мин или «Выкл». За 30 секунд до блокировки — тост «Сессия истекает через N с…». При истечении — плавное усиление `backdrop-blur` на весь экран, затем вызов логаута (cookie сбрасывается, редирект на `/`).

- **Интеграция с Telegram для лидов**  
  В админке (вкладка «Интеграции») — поля Bot Token и Chat ID. Хранение в `settings.telegram`; отправка лидов в бота в текущем коде не реализована, подготовлена структура данных.

- **Digital Twin (2D планировка)**  
  Компонент `DigitalTwin`: SVG-планировка из конфига (зоны hall/bath/kitchen/living, стены, мебель). Прогресс 0–100 (например, доля взноса) определяет заливку зон. Подсветка по сценарию (gold/blue/default). Брендовый цвет из конфига админки.

---

## 4. Визуальный ДНК

- **Шрифты:** Geist Sans и Geist Mono (`next/font/google`), переменные `--font-geist-sans`, `--font-geist-mono`; в Tailwind theme заданы `--font-sans` и `--font-mono`.
- **Фон:** тёмная тема. Главная: `bg-[#0c0c0e]`, радиальный градиент в стиле macOS (`ellipse_80%_60%_at_50%_-20%`, синий с низкой непрозрачностью). Админка: `bg-zinc-950`, такие же мягкие градиенты.
- **Стекло (glassmorphism):** карточки и блоки — `bg-white/5`, `bg-white/10`, `border border-white/10`, `backdrop-blur-xl` / `backdrop-blur-2xl`. Кнопки и сегменты — полупрозрачные с лёгким свечением.
- **Скругления:** системно `rounded-2xl`, `rounded-3xl` для карточек и контейнеров; `rounded-xl` для полей и кнопок; `rounded-full` для тумблеров и pill-кнопок.
- **Цвета:** основной акцент — Apple Blue `#007AFF` (из конфига переопределяется на `brand.primaryColor`). Текст: `text-white`, `text-zinc-400`/`text-zinc-500` для второстепенного. Успех — `emerald-400/500`, ошибка/негатив — `rose-400/500`. Sparklines: Investment #EAB308, Family #007AFF, Start #10B981.
- **Инпуты:** нижняя граница `border-b border-white/5`, при фокусе `focus:ring-1 focus:ring-[#007AFF]`, стиль под iOS (минималистичные поля).
- **Анимации:** Framer Motion для появления блоков, переключения вкладок и режима презентации; плавные переходы 0.2–0.5 s, ease. Пульсирующая точка у «Данные актуальны» — Tailwind `animate-ping`.

---

## 5. Логика данных

### Объект `settings` (AdminSettings) в localStorage
- **branding:** `companyName`, `primaryColor`, `logoUrl`
- **telegram:** `botToken`, `chatId`
- **inflationRate:** число (процент, например 4)
- **adminPassword:** строка (для отображения в UI; проверка входа только через API)
- **lastLogin:** ISO-строка времени последнего входа (записывается при успешном логине)
- **security:** `autoLockMinutes` (0 | 5 | 15 | 30), `showTimestampInReport`, `pdfWatermark`
- **rates:** три профиля — `investment`, `family`, `start`. В каждом: `bankRate`, `taxRate`, `priceGrowth` (в процентах).

### Три финансовые стратегии
- **Инвестиция:** ставка 4.5%, налог 0%, рост цен задаётся в админке; типично для зарубежных объектов (например ОАЭ).
- **Семья:** ставка и налог под льготные/семейные программы (в т.ч. РФ); рост цен и инфляция общие.
- **Старт:** «первое жильё», свои комбинации ставки/налога/роста.

На главной странице симулятора **базовые ставки** (ratePercent, priceGrowthPercent) берутся из профиля **family** через `getConfigFromStorage()`. Пресеты сценариев (investor/family/entry) в `config.scenarioPresets` задают начальные цену, взнос, ставку и срок при выборе сценария; детальные ставки по стратегиям в админке используются для виджета Live ROI и Sparklines. Рост стоимости в расчётах: **номинальный рост = глобальная инфляция + премия (поле «Рост цен»)**.

---

## 6. Сложность

- **Синхронизация админка ↔ симулятор без бэкенда.** Вся конфигурация живёт в localStorage. Главная страница не знает об админке «из коробки» — конфиг подтягивается при загрузке и по событию `ifsVisionAdminUpdated`. Миграции старых ключей (например `baseRates` → `rates` с тремя профилями) и аккуратное слияние при чтении из localStorage реализованы в `admin-storage.ts`. Риск: при нескольких вкладках с разными версиями настроек возможна рассинхронизация до перезагрузки или повторного сохранения в админке.

- **Безопасность сессий.** Переход на HTTP-only cookie и проверку пароля только на сервере убрал пароль из клиента и защитил от XSS в плане доступа к админке. Middleware гарантирует, что по прямому URL `/studio-admin` без cookie пользователь уходит на главную. Смена пароля в UI пока не меняет серверный `ADMIN_PASSWORD` (только локальное отображаемое значение).

- **Экспорт PDF через сторонний Screenshot API.** Отчёт — это скриншот блока `#simulation-report` по URL с `export=1` и параметрами времени. Зависимость от внешнего сервиса и необходимость подставлять `NEXT_PUBLIC_SITE_URL` при localhost добавляют операционную сложность и требуют аккуратной настройки окружения.

- **Единый источник правды для бренда и ставок.** Конфиг на главной формируется из статического `config` и переопределений из localStorage (`getConfigFromStorage`). Дублирование дефолтов (в `config.ts` и в `defaultSettings` в admin-storage) и разные имена полей (например `ratePercent` vs `bankRate`) требуют внимания при добавлении новых настроек, чтобы не разъехались админка и симулятор.

---

## Резюме для вектора развития

Продукт — сильный MVP: один маршрут симулятора, один маршрут админки с cookie-защитой, расчёты в `FinancialEngine`, визуал в едином стеклянном стиле. Код готов к расширению: добавление мультивалютности, сравнения сценариев или A/B пресетов упирается в основном в расширение типов в `admin-storage` и `useStore`, а не в переписывание архитектуры. Слабое место — отсутствие серверного хранилища настроек и пароля: для мультитенанта или смены пароля из UI без деплоя понадобится бэкенд (БД или файл) и соответствующие API.
